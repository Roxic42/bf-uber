<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber... for my BF</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Make the map take up the full screen height */
        #map { height: 100vh; }
        /* Custom pulsing animation for the driver icon */
        .pulse {
            border-radius: 50%;
            animation: pulse-animation 2s infinite;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 1);
        }
        @keyframes pulse-animation {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- The Map Container -->
    <div id="map" class="z-0"></div>

    <!-- UI Panel -->
    <div id="ui-panel" class="absolute top-0 left-0 right-0 p-4 z-10">
        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-5 space-y-4">

            <!-- Configuration View (initial setup for rider) -->
            <div id="config-view">
                <h1 class="text-2xl font-bold text-center text-gray-800">BF-Uber Setup</h1>
                <p class="text-sm text-gray-500 text-center mb-4">Just a few details to get this working for you!</p>
                <div>
                    <label for="riderName" class="block text-sm font-medium text-gray-700">Your Name:</label>
                    <input type="text" id="riderName" placeholder="e.g. Ana" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="driverName" class="block text-sm font-medium text-gray-700">His Name:</label>
                    <input type="text" id="driverName" placeholder="e.g. Marko" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="driverPhone" class="block text-sm font-medium text-gray-700">His Phone Number (for WhatsApp):</label>
                     <div class="flex items-center mt-1">
                        <span class="inline-block bg-gray-200 px-3 py-2 border border-r-0 border-gray-300 rounded-l-md text-gray-600">+385</span>
                        <input type="tel" id="driverPhone" placeholder="91234567" class="block w-full px-3 py-2 border border-gray-300 rounded-r-md shadow-sm">
                    </div>
                </div>
                <button id="saveConfig" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Save & Start</button>
                <p id="config-error" class="text-red-500 text-sm text-center mt-2 hidden"></p>
            </div>

            <!-- Rider View -->
            <div id="rider-view" class="hidden space-y-3">
                 <h1 class="text-2xl font-bold text-center text-gray-800">Hey <span id="riderNameDisplay"></span>!</h1>
                 <p id="rider-status-text" class="text-center text-gray-600 text-sm">Drag the pin to set your pickup location.</p>
                 <div class="bg-gray-50 p-3 rounded-lg text-center">
                    <p class="text-xs text-gray-500">Pickup Address</p>
                    <p id="pickup-address" class="font-semibold text-gray-800 h-10 flex items-center justify-center">Finding address...</p>
                 </div>
                 <div id="ride-actions" class="space-y-3">
                    <button id="request-ride-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 text-lg">Request a Ride</button>
                    <div id="request-options" class="hidden grid grid-cols-2 gap-3">
                        <button id="summon-now-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Summon Now</button>
                        <button id="schedule-later-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Schedule for Later</button>
                    </div>
                    <div id="scheduler" class="hidden space-y-3 pt-2">
                        <label for="schedule-time" class="block text-sm font-medium text-gray-700">Pickup time:</label>
                        <input type="datetime-local" id="schedule-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        <button id="confirm-schedule-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Confirm Schedule</button>
                    </div>
                 </div>
                 <div id="active-ride-status" class="hidden text-center space-y-3">
                    <div id="scheduled-info" class="hidden p-3 bg-blue-50 rounded-lg">
                        <p class="font-bold text-blue-800">Ride Scheduled!</p>
                        <p id="scheduled-time-display" class="text-blue-700"></p>
                        <p class="text-xs text-blue-600 mt-2">Keep this page open to send the notification automatically.</p>
                    </div>
                     <button id="cancel-ride-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 text-sm">Cancel Ride</button>
                 </div>
            </div>
            
            <!-- Driver View -->
            <div id="driver-view" class="hidden space-y-3">
                 <h1 class="text-2xl font-bold text-center text-gray-800">Hey <span id="driverNameDisplay"></span>!</h1>
                 <p class="text-center text-gray-600">Your location is now being shared.</p>
                 <div id="driver-status-text" class="text-center font-semibold text-indigo-600 p-3 bg-indigo-50 rounded-lg">Sharing Location...</div>
                 <button id="arrived-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">I've Arrived!</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsJHiE0iwgXSbI2SjfglM7I-DXXNq9KXwY",
            authDomain: "bf-uber-16ffa.firebaseapp.com",
            projectId: "bf-uber-16ffa",
            storageBucket: "bf-uber-16ffa.appspot.com",
            messagingSenderId: "545966168464",
            appId: "1:545966168464:web:76fa8e801c47f9ca7b15",
            measurementId: "G-2YK3CX1B31"
        };
        
        const ZAGREB_COORDS = [45.8150, 15.9819];
        const appId = 'bf-uber-app-123'; 
        
        let db, auth, userId, map, riderMarker, driverMarker, rideDocRef;
        let isDriverMode = false;
        let scheduleCheckInterval = null;
        let config = {};
        
        const ui = {
            configView: document.getElementById('config-view'),
            riderView: document.getElementById('rider-view'),
            driverView: document.getElementById('driver-view'),
        };

        function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        rideDocRef = doc(db, "rides", appId);
                        handleAppLoad();
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="p-4 text-red-500">Error: Could not initialize the app. Check console for details.</div>`;
            }
        }

        function handleAppLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            isDriverMode = urlParams.get('mode') === 'driver';

            const savedConfig = localStorage.getItem(`bfUberConfig_${appId}`);
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }

            if (isDriverMode) {
                if (!config.driverName) {
                    // This can happen if the driver clears cache. Prompt for name.
                    const driverName = prompt("Please enter your name:", "Driver");
                    config.driverName = driverName || 'Driver';
                }
                initializeAppUI();
            } else {
                if (savedConfig) {
                    initializeAppUI();
                } else {
                    ui.configView.classList.remove('hidden');
                    document.getElementById('saveConfig').addEventListener('click', saveConfigAndStart);
                }
            }
        }
        
        function normalizePhoneNumber(phone) {
            return `385${phone.replace(/^0+/, '').replace(/\s+/g, '')}`;
        }
        
        function saveConfigAndStart() {
            const errorEl = document.getElementById('config-error');
            errorEl.classList.add('hidden');

            const newConfig = {
                riderName: document.getElementById('riderName').value,
                driverName: document.getElementById('driverName').value,
                driverPhone: normalizePhoneNumber(document.getElementById('driverPhone').value)
            };
            
            if (!newConfig.riderName || !newConfig.driverName || !newConfig.driverPhone) {
                errorEl.textContent = 'Please fill in all fields.';
                errorEl.classList.remove('hidden');
                return;
            }
            config = newConfig;
            localStorage.setItem(`bfUberConfig_${appId}`, JSON.stringify(config));
            
            ui.configView.classList.add('hidden');
            initializeAppUI();
        }
        
        function initializeAppUI() {
            document.getElementById('riderNameDisplay').textContent = config.riderName;
            document.getElementById('driverNameDisplay').textContent = config.driverName;
            
            map = L.map('map').setView(ZAGREB_COORDS, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            if (isDriverMode) {
                ui.configView.classList.add('hidden');
                ui.riderView.classList.add('hidden');
                setupDriverView();
            } else {
                ui.configView.classList.add('hidden');
                ui.driverView.classList.add('hidden');
                setupRiderView();
            }
            listenToRideStatus();
        }

        function setupRiderView() {
            ui.riderView.classList.remove('hidden');
            const riderIcon = L.divIcon({ html: 'üìç', className: 'text-4xl', iconSize: [30, 40], iconAnchor: [15, 40] });
            riderMarker = L.marker(map.getCenter(), { icon: riderIcon, draggable: true }).addTo(map);
            
            navigator.geolocation.getCurrentPosition(pos => {
                const userLatLng = [pos.coords.latitude, pos.coords.longitude];
                map.setView(userLatLng, 15);
                riderMarker.setLatLng(userLatLng);
                updatePickupAddress(userLatLng);
            }, () => updatePickupAddress(map.getCenter()), {enableHighAccuracy: true});

            riderMarker.on('dragend', () => updatePickupAddress(riderMarker.getLatLng()));
            document.getElementById('request-ride-btn').addEventListener('click', () => {
                document.getElementById('request-options').classList.remove('hidden');
                document.getElementById('request-ride-btn').classList.add('hidden');
            });
            document.getElementById('summon-now-btn').addEventListener('click', () => summonDriver(riderMarker.getLatLng()));
            document.getElementById('schedule-later-btn').addEventListener('click', () => {
                document.getElementById('scheduler').classList.remove('hidden');
                document.getElementById('request-options').classList.add('hidden');
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('schedule-time').min = now.toISOString().slice(0,16);
            });
            document.getElementById('confirm-schedule-btn').addEventListener('click', scheduleRide);
            document.getElementById('cancel-ride-btn').addEventListener('click', resetRide);
        }
        
        async function updatePickupAddress(latlngArr) {
            const addressEl = document.getElementById('pickup-address');
            addressEl.textContent = 'Finding address...';
            const latlng = Array.isArray(latlngArr) ? { lat: latlngArr[0], lng: latlngArr[1] } : latlngArr;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
                const data = await response.json();
                addressEl.textContent = data.display_name.split(',').slice(0, 3).join(',');
            } catch (e) { addressEl.textContent = 'Could not find address'; }
        }

        async function summonDriver(pickupLatLng) {
            const pickup = { lat: pickupLatLng.lat, lng: pickupLatLng.lng };
            const wazeLink = `https://waze.com/ul?ll=${pickup.lat},${pickup.lng}&navigate=yes`;
            const driverAppLink = `${window.location.href.split('?')[0]}?mode=driver`;
            const message = encodeURIComponent(
                `Hey ${config.driverName}! I need a ride! üöó\n\n` +
                `üìç Pickup Location: Tap to navigate with Waze:\n${wazeLink}\n\n` +
                `-------\n` +
                `üî¥ IMPORTANT: Open this link to start sharing your location with me:\n${driverAppLink}`
            );
            const whatsappUrl = `https://wa.me/${config.driverPhone}?text=${message}`;
            await setDoc(rideDocRef, {
                status: 'requested', pickupLocation: pickup, driverLocation: null,
                riderName: config.riderName, driverName: config.driverName, scheduledTime: null
            });
            window.open(whatsappUrl, '_blank');
        }

        async function scheduleRide() {
            const scheduledTimeValue = document.getElementById('schedule-time').value;
            if (!scheduledTimeValue) return;
            const scheduledTime = new Date(scheduledTimeValue);
            if (scheduledTime < new Date()) return;

            const pickupLatLng = riderMarker.getLatLng();
            const pickup = { lat: pickupLatLng.lat, lng: pickupLatLng.lng };
            await setDoc(rideDocRef, {
                status: 'scheduled', pickupLocation: pickup, driverLocation: null,
                riderName: config.riderName, driverName: config.driverName, scheduledTime: scheduledTime.toISOString()
            });
        }
        
        function setupDriverView() {
            ui.driverView.classList.remove('hidden');
            document.getElementById('arrived-btn').addEventListener('click', markAsArrived);
            navigator.geolocation.watchPosition(async (position) => {
                const driverLatLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                await updateDoc(rideDocRef, { driverLocation: driverLatLng, status: 'enroute' });
            }, (error) => {
                console.error("Geolocation error:", error);
                document.getElementById('driver-status-text').textContent = 'Location permissions denied.';
            }, { enableHighAccuracy: true, maximumAge: 0 });
        }

        async function markAsArrived() { await updateDoc(rideDocRef, { status: 'arrived' }); }
        
        async function resetRide() {
             await setDoc(rideDocRef, { status: 'idle', pickupLocation: null, driverLocation: null, scheduledTime: null });
             window.location.reload();
        }

        function listenToRideStatus() {
            onSnapshot(rideDocRef, (doc) => {
                const rideData = doc.data() || { status: 'idle' };
                updateUIFromRideData(rideData);

                if (rideData.driverLocation && !isDriverMode) {
                    const driverLatLng = [rideData.driverLocation.lat, rideData.driverLocation.lng];
                    if (!driverMarker) {
                         const driverIcon = L.divIcon({
                            html: `<div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white text-lg font-bold shadow-lg pulse">üöó</div>`,
                            className: '', iconSize: [32, 32], iconAnchor: [16, 16]
                        });
                        driverMarker = L.marker(driverLatLng, {icon: driverIcon}).addTo(map);
                    } else { driverMarker.setLatLng(driverLatLng); }
                    
                    if(rideData.status === 'enroute' && riderMarker) {
                        const bounds = L.latLngBounds([riderMarker.getLatLng(), driverMarker.getLatLng()]);
                        map.fitBounds(bounds.pad(0.3));
                    }
                }
            });
        }
        
        function updateUIFromRideData(rideData) {
            const { status, scheduledTime, pickupLocation } = rideData;
            if (scheduleCheckInterval) { clearInterval(scheduleCheckInterval); scheduleCheckInterval = null; }
            
            const riderStatusText = document.getElementById('rider-status-text');
            const rideActions = document.getElementById('ride-actions');
            const activeRideStatus = document.getElementById('active-ride-status');
            const scheduledInfo = document.getElementById('scheduled-info');

            rideActions.classList.add('hidden');
            activeRideStatus.classList.add('hidden');
            scheduledInfo.classList.add('hidden');
            if (riderMarker) riderMarker.dragging.enable();

            switch (status) {
                case 'scheduled':
                    activeRideStatus.classList.remove('hidden');
                    scheduledInfo.classList.remove('hidden');
                    riderStatusText.textContent = `Your ride is scheduled. Waiting...`;
                    if (riderMarker) riderMarker.dragging.disable();
                    const time = new Date(scheduledTime);
                    document.getElementById('scheduled-time-display').textContent = time.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                    if (!isDriverMode) {
                        scheduleCheckInterval = setInterval(() => {
                            if (new Date() >= time) {
                                clearInterval(scheduleCheckInterval);
                                summonDriver(pickupLocation);
                            }
                        }, 1000);
                    }
                    break;
                case 'requested':
                    activeRideStatus.classList.remove('hidden');
                    riderStatusText.textContent = `Waiting for ${config.driverName} to start driving...`;
                    if (riderMarker) riderMarker.dragging.disable();
                    break;
                case 'enroute':
                    activeRideStatus.classList.remove('hidden');
                    riderStatusText.textContent = `${config.driverName} is on the way!`;
                    if (riderMarker) riderMarker.dragging.disable();
                    if (isDriverMode) { document.getElementById('driver-status-text').textContent = `You are on your way to ${rideData.riderName || 'her'}!`; }
                    break;
                case 'arrived':
                    activeRideStatus.classList.remove('hidden');
                    riderStatusText.textContent = `${config.driverName} has arrived! üéâ`;
                    if (riderMarker) riderMarker.dragging.disable();
                    if (driverMarker) driverMarker.getElement().querySelector('div').classList.remove('pulse');
                    if (isDriverMode) {
                       document.getElementById('driver-status-text').textContent = `You've arrived! Great job!`;
                       const btn = document.getElementById('arrived-btn');
                       btn.disabled = true;
                       btn.textContent = 'Arrived!';
                    }
                    break;
                case 'idle':
                default:
                    rideActions.classList.remove('hidden');
                    riderStatusText.textContent = 'Drag the pin to set your pickup location.';
                    document.getElementById('request-ride-btn').classList.remove('hidden');
                    document.getElementById('request-options').classList.add('hidden');
                    document.getElementById('scheduler').classList.add('hidden');
                    if(driverMarker) {
                        map.removeLayer(driverMarker);
                        driverMarker = null;
                    }
            }
        }
        main();
    </script>
</body>
</html>

